<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"byc.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="学吧，学无止境">
<meta property="og:type" content="website">
<meta property="og:title" content="卡车斯基">
<meta property="og:url" content="http://byc.github.io/index.html">
<meta property="og:site_name" content="卡车斯基">
<meta property="og:description" content="学吧，学无止境">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="BYC">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="hack">
<meta property="article:tag" content="math">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://byc.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>卡车斯基</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">卡车斯基</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Veni, Vidi, Vici</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://byc.github.io/2024/01/16/check-static-pods/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="BYC">
      <meta itemprop="description" content="学吧，学无止境">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="卡车斯基">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/01/16/check-static-pods/" class="post-title-link" itemprop="url">如何判断静态容</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-01-16 21:29:56 / 修改时间：21:44:47" itemprop="dateCreated datePublished" datetime="2024-01-16T21:29:56+08:00">2024-01-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>383</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>直接由特定节点上的kubelet进程来管理，不通过 master 节点上的apiserver。无法与我们常用的控制器Deployment或者DaemonSet进行关联，它由kubelet进程自己来监控，当pod崩溃时重启该pod，kubelete也无法对他们进行健康检查。在K8S集群，可以通过<code>kubectl</code>命令查看容器是否为静态Pod</p>
<h2 id="查找对应容器"><a href="#查找对应容器" class="headerlink" title="查找对应容器"></a>查找对应容器</h2><p>查看<code>kube-system</code>命名空间下的所有Pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<p>Pod列表👇<br><a href="https://imgse.com/i/pFixyzq" target="_blank" rel="noopener"><img src="https://s11.ax1x.com/2024/01/15/pFixyzq.png" alt="pFixyzq.png"></a></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>使用<code>kubectl describe</code>命令查看Pod状态，以etcd为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod etcd-master1 -n kube-system</span><br></pre></td></tr></table></figure>

<p>Pod信息👇<br><a href="https://imgse.com/i/pFixXwD" target="_blank" rel="noopener"><img src="https://s11.ax1x.com/2024/01/15/pFixXwD.png" alt="pFixXwD.png"></a></p>
<p>查看输出中，<code>Controlled By</code>为<code>Node/master1</code>，如果是通过K8S管理的动态容器此处为<code>ReplicaSet</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://byc.github.io/2020/08/22/neokylin-vsftp-quick-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="BYC">
      <meta itemprop="description" content="学吧，学无止境">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="卡车斯基">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/22/neokylin-vsftp-quick-setup/" class="post-title-link" itemprop="url">中标麒麟安装FTP并快速配置匿名用户</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-08-22 17:18:25 / 修改时间：22:12:16" itemprop="dateCreated datePublished" datetime="2020-08-22T17:18:25+08:00">2020-08-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>858</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文介绍了如何在中标麒麟系统中离线安装<code>vsftp</code>服务器，并快速开启匿名用户登录，上传下载功能。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在离线环境中，可以使用中标系统安装光盘作为<code>yum</code>源安装软件，避免出现依赖问题。</p>
<h3 id="配置光盘源"><a href="#配置光盘源" class="headerlink" title="配置光盘源"></a>配置光盘源</h3><p>👉 拷贝软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /Repo</span><br><span class="line">cp -r &#123;光盘目录&#125;/Packages /Repo/</span><br><span class="line">cp -r &#123;光盘目录&#125;/repodata /Repo/</span><br></pre></td></tr></table></figure>

<p>👉 配置<code>yum</code>源<br>在<code>/etc/yum.repos.d/</code>路径下，可能存在多个源配置文件，可以选择<code>neokylin.repo</code>或<code>offline.repo</code>修改为以下内容（做好备份）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 光盘源</span><br><span class="line">[DVD]</span><br><span class="line">name&#x3D;DVD repo</span><br><span class="line">baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;Repo&#x2F;</span><br><span class="line">gpgcheck&#x3D;</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgkey&#x3D;</span><br></pre></td></tr></table></figure>

<h3 id="安装vsftp"><a href="#安装vsftp" class="headerlink" title="安装vsftp"></a>安装<code>vsftp</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y vsftpd</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>👉 配置匿名用户<br>修改<code>/etc/vsftpd/vsftpd.conf</code>文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">anonymous_enable&#x3D;YES</span><br><span class="line">write_enable&#x3D;YES</span><br><span class="line">anon_upload_enable&#x3D;YES</span><br><span class="line">anon_mkdir_write_enable&#x3D;YES</span><br><span class="line">anon_other_write_enable&#x3D;YES</span><br><span class="line">anon_umask&#x3D;022</span><br><span class="line">anon_world_readable_only&#x3D;YES</span><br></pre></td></tr></table></figure>

<p>👉 重启服务，设置开机自启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd</span><br><span class="line">systemctl <span class="built_in">enable</span> vsftpd</span><br></pre></td></tr></table></figure>

<ul>
<li>重启服务后，客户端可以通过<code>anonymous</code>用户登录服务器，默认目录为服务器的<code>/var/ftp/pub</code>目录</li>
<li>⚠️  中标麒麟系统默认开启了防火墙，需要关闭或配置防火墙策略才能访问<code>ftp</code>服务</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上操作使用<code>root</code>用户，可以快速开启<code>ftp</code>服务器的匿名用户，以及上传下载权限。另外关闭防火墙是不安全的，需谨慎使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://byc.github.io/2020/07/19/traefik2-tcp-tls-configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="BYC">
      <meta itemprop="description" content="学吧，学无止境">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="卡车斯基">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/19/traefik2-tcp-tls-configuration/" class="post-title-link" itemprop="url">Traefik2 tcp over tls 配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-19 10:53:36" itemprop="dateCreated datePublished" datetime="2020-07-19T10:53:36+08:00">2020-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-23 11:25:10" itemprop="dateModified" datetime="2020-07-23T11:25:10+08:00">2020-07-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>Traefik</code>是一款主流的反向代理服务器以及负载均衡器，其有着强大的功能和性能，是<a href="https://landscape.cncf.io/selected=traefik" target="_blank" rel="noopener">CNCF</a>中的一员。在<code>Kubernetes</code>集群中，<code>Traefik</code>可以被用做<code>Ingress Controller</code>用来访问集群内部服务。从<code>Traefik 2.0</code>版本开始支持<code>TCP</code>协议以及基于<code>SNI</code>的路由配置。本文介绍了<code>Traefik</code>在<code>Kubernetes</code>集群中的部署，并用一个实例演示如何通过服务名称访问集群中的<code>TCP</code>服务。</p>
<h2 id="部署Traefik"><a href="#部署Traefik" class="headerlink" title="部署Traefik"></a>部署Traefik</h2><p>示例中的集群有3个工作节点，以<code>Deployment</code>部署<code>Traefik</code>，<code>pod</code>副本数为2个。通过绑定主机端口将<code>Traefik</code>暴露给集群外部，并通过<code>keepalived</code>保证高可用：</p>
<div align="center"><img src="https://i.loli.net/2020/07/21/FyAiIBZ95UCqc7K.png" width="70%"></div>

<ul>
<li><code>Deployment</code>的<code>Pod</code>副本数为<code>2</code>，可以通过亲和性使同一节点副本数不大于<code>1</code></li>
<li><code>keepalived</code>通过检查<code>Traefik</code>容器绑定的主机端口维护<code>VIP</code></li>
</ul>
<p>👉 在集群中创建<code>Traefik 2.0</code>的<code>CRD</code>、<code>ClusterRole</code>、<code>ClusterRoleBinding</code>以及<code>ServiceAccount</code>等对象，定义在文件<em>traefki-rc.yaml</em>中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># All resources definition must be declared</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutes.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressroutes</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressroute</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">middlewares.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">middlewares</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">middleware</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutetcps.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRouteTCP</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressroutetcps</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressroutetcp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tlsoptions.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TLSOption</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">tlsoptions</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">tlsoption</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefikservices.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">traefikservices</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">traefikservice</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik.containo.us</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middlewares</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressroutes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefikservices</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressroutetcps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlsoptions</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br></pre></td></tr></table></figure>

<p>👉 创建<code>Deployment</code>，<em>traefik-dp.yaml</em>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">traefik:v2.1.6</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=DEBUG</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--api</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--api.insecure</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--entrypoints.tcpep.address=:23235</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--entrypoints.web.address=:80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--providers.kubernetescrd</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--providers.kubernetesingress</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcpep</span>                      <span class="comment"># TCP入口</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">23235</span></span><br><span class="line">              <span class="attr">hostPort:</span> <span class="number">23235</span>                  <span class="comment"># 绑定主机端口</span></span><br></pre></td></tr></table></figure>
<ul>
<li>开启<code>TCP</code>入口点</li>
<li><code>TCP</code>入口点绑定<code>hostPort</code></li>
</ul>
<h2 id="生成证书文件"><a href="#生成证书文件" class="headerlink" title="生成证书文件"></a>生成证书文件</h2><p>这里使用工具<a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener">cfssl</a>生成服务器端所需的<code>X.509</code>证书秘钥对，另外<code>Traefik</code>还支持通过<a href="https://docs.traefik.io/https/acme/" target="_blank" rel="noopener">Let’s Encrypt</a>实现证书的自动申请、管理功能。</p>
<h3 id="生成CA"><a href="#生成CA" class="headerlink" title="生成CA"></a>生成CA</h3><p>👉 CA请求文件<em>ca-csr.json</em>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"tcpdemo"</span>,</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"BJ"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"BJ"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"Cluster"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"Tcpdemo"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"ca"</span>: &#123;</span><br><span class="line">    <span class="attr">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>👉 生成CA：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure>
<ul>
<li>生成的自签CA秘钥对为ca.pem、ca-key.pem</li>
</ul>
<h3 id="生成服务器证书-amp-秘钥"><a href="#生成服务器证书-amp-秘钥" class="headerlink" title="生成服务器证书&amp;秘钥"></a>生成服务器证书&amp;秘钥</h3><p>👉 配置文件<em>ca-config.json</em>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"signing"</span>: &#123;</span><br><span class="line">    <span class="attr">"default"</span>: &#123;</span><br><span class="line">      <span class="attr">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">      <span class="attr">"tcpdemo"</span>: &#123;</span><br><span class="line">        <span class="attr">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>👉 签名请求文件<em>ca-csr.json</em>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"service1.tcpdemo.cluster"</span>,</span><br><span class="line">  <span class="attr">"hosts"</span>: [</span><br><span class="line">    <span class="string">"service1.tcpdemo.cluster"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"BJ"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"BJ"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"Cluster"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"Tcpdemo"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>👉 生成服务端证书秘钥对：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=tcpdemo service1-csr.json | cfssljson -bare service1</span><br></pre></td></tr></table></figure>
<ul>
<li>生成的服务端证书秘钥对为service1.pem、service1-key.pem</li>
</ul>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>Demo程序包括<code>Qt</code>编写的客户端和<code>go</code>编写的服务端两部分，通过<code>TCP</code>进行简单通信。在配置了<code>Traefik</code>路由后，客户端可以实现基于<code>SAN</code>的服务访问。另外，<code>Traefik</code>还支持可配置的<code>TLS Termination</code>：</p>
<div align="center"><img src="https://i.loli.net/2020/07/21/2NgGultaS7hRjTK.png" width="70%"></div>

<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>👉 服务端使用<code>go</code>编写，<em>main.go</em>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// "crypto/tls"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/prometheus/common/log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// cert, err := tls.LoadX509KeyPair("/certs/tls.crt", "/certs/tls.key")</span></span><br><span class="line">	<span class="comment">// if err != nil &#123;</span></span><br><span class="line">	<span class="comment">// 	log.Fatal("load key pair failed!")</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// config := tls.Config&#123;</span></span><br><span class="line">	<span class="comment">// 	Certificates:       []tls.Certificate&#123;cert&#125;,</span></span><br><span class="line">	<span class="comment">// 	InsecureSkipVerify: true,</span></span><br><span class="line">	<span class="comment">// 	ClientAuth:         tls.NoClientCert,</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	server := <span class="string">"0.0.0.0:12345"</span></span><br><span class="line">	<span class="comment">// listener, err := tls.Listen("tcp", server, &amp;config)       // !TLS Termination</span></span><br><span class="line">	listener, err := net.Listen(<span class="string">"tcp"</span>, server)                   <span class="comment">// TLS Termination</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">"tcp listen failed!"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Info(<span class="string">"tcp server listenning ..."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		conn, err := listener.Accept()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Error(<span class="string">"tcp accept failed!"</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> conn.Close()</span><br><span class="line">		log.Info(<span class="string">"tcp accepted from: "</span>, conn.RemoteAddr())</span><br><span class="line">		<span class="keyword">go</span> handleClient(conn)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleClient</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">512</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		log.Info(<span class="string">"tcp buff waiting ..."</span>)</span><br><span class="line">		n, err := conn.Read(buf)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Info(<span class="string">"tcp read buff error: "</span>, err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Info(<span class="string">"tcp read buff: "</span>, <span class="keyword">string</span>(buf[:n]))</span><br><span class="line"></span><br><span class="line">		n, err = conn.Write([]<span class="keyword">byte</span>(<span class="string">"server hello: "</span> + os.Getenv(<span class="string">"SERVICE_ID"</span>) + <span class="string">"\n"</span>))</span><br><span class="line">		log.Info(<span class="string">"tcp wrote buff: "</span>, n)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Info(<span class="string">"tcp wrote buff error: "</span>, err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	log.Info(<span class="string">"tcp conn closed"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>👉 静态编译，便于打包<code>Docker</code>镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 go build -a -ldflags <span class="string">'-extldflags "-static"'</span> -o tlsserver</span><br></pre></td></tr></table></figure>
<ul>
<li>服务端通过12345端口与客户端通信</li>
<li>服务端收到客户端消息后，返回环境变量<code>SERVICE_ID</code></li>
<li>注释部分对应<code>Traefik</code>路由配置中<code>passthrough</code>为<code>true</code>，即禁用<code>TLS Termination</code></li>
</ul>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>👉 客户端为<code>Qt</code>编写的<code>GUI</code>程序，<em>mainwindow.cpp</em>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"mainwindow.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ui_mainwindow.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QTime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMessageBox&gt;</span></span></span><br><span class="line"></span><br><span class="line">MainWindow::MainWindow(QWidget *parent) :</span><br><span class="line">    QMainWindow(parent),</span><br><span class="line">    ui(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;setupUi(<span class="keyword">this</span>);</span><br><span class="line">    socket = <span class="keyword">new</span> QSslSocket();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(socket, &amp;QSslSocket::readyRead, <span class="keyword">this</span>, &amp;MainWindow::socket_Read_Data);</span><br><span class="line">    <span class="built_in">connect</span>(socket, &amp;QSslSocket::disconnected, <span class="keyword">this</span>, &amp;MainWindow::socket_Disconnected);</span><br><span class="line">    <span class="built_in">connect</span>(socket, SIGNAL(sslErrors(QList&lt;QSslError&gt;)), <span class="keyword">this</span>, SLOT(sslErrors(QList&lt;QSslError&gt;)));</span><br><span class="line">    <span class="built_in">connect</span>(socket, SIGNAL(error(QAbstractSocket::SocketError)), <span class="keyword">this</span>, SLOT(socket_error(QAbstractSocket::SocketError)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加CA</span></span><br><span class="line">    <span class="keyword">if</span>(!socket-&gt;addCaCertificates(<span class="string">"ca.pem"</span>))&#123;</span><br><span class="line">            QMessageBox::information(<span class="keyword">this</span>, <span class="string">"Error"</span>, <span class="string">"failed to add ca"</span>, QMessageBox::Ok);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验证客户端证书需要</span></span><br><span class="line">    <span class="comment">// socket-&gt;setPrivateKey("client.key");</span></span><br><span class="line">    <span class="comment">// socket-&gt;setLocalCertificate("client.pem");</span></span><br><span class="line">    <span class="comment">// 需要验证</span></span><br><span class="line">    socket-&gt;setPeerVerifyMode(QSslSocket::VerifyPeer);</span><br><span class="line">    ui-&gt;lineEdit_IP-&gt;setText(<span class="string">"192.168.78.170"</span>);</span><br><span class="line">    ui-&gt;lineEdit_SAN-&gt;setText(<span class="string">"service1.tcpdemo.cluster"</span>);</span><br><span class="line">    ui-&gt;lineEdit_Port-&gt;setText(<span class="string">"23235"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MainWindow::~MainWindow()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>-&gt;socket;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::on_pushButton_Send_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString IP;</span><br><span class="line">    QString SAN;</span><br><span class="line">    <span class="keyword">int</span> port;</span><br><span class="line">    QString str = ui-&gt;textEdit_Recv-&gt;toPlainText();</span><br><span class="line">    <span class="comment">//获取IP地址</span></span><br><span class="line">    IP = ui-&gt;lineEdit_IP-&gt;<span class="built_in">text</span>();</span><br><span class="line">    <span class="comment">//SAN</span></span><br><span class="line">    SAN = ui-&gt;lineEdit_SAN-&gt;<span class="built_in">text</span>();</span><br><span class="line">    <span class="comment">//获取端口号</span></span><br><span class="line">    port = ui-&gt;lineEdit_Port-&gt;<span class="built_in">text</span>().toInt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消已有的连接</span></span><br><span class="line">    socket-&gt;<span class="built_in">abort</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//刷新显示</span></span><br><span class="line">    ui-&gt;textEdit_Recv-&gt;setText(str);</span><br><span class="line">    QTextCursor <span class="built_in">cursor</span>=ui-&gt;textEdit_Recv-&gt;textCursor();</span><br><span class="line">    <span class="built_in">cursor</span>.movePosition((QTextCursor::End));</span><br><span class="line">    ui-&gt;textEdit_Recv-&gt;setTextCursor((<span class="built_in">cursor</span>));</span><br><span class="line">    <span class="comment">// 连接服务器，设置SAN</span></span><br><span class="line">    socket-&gt;connectToHostEncrypted(IP, quint16(port), SAN);</span><br><span class="line">    <span class="keyword">if</span>(socket-&gt;waitForEncrypted(<span class="number">500</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        QString tmptime=QTime::currentTime().toString(<span class="string">"HH:mm:ss"</span>);</span><br><span class="line">        QString tmpstr = QString(<span class="string">"%1 连接成功\n"</span>).arg(tmptime);</span><br><span class="line">        str+=tmpstr;</span><br><span class="line">        <span class="comment">//刷新显示</span></span><br><span class="line">        ui-&gt;textEdit_Recv-&gt;setText(str);</span><br><span class="line">        QTextCursor <span class="built_in">cursor</span>=ui-&gt;textEdit_Recv-&gt;textCursor();</span><br><span class="line">        <span class="built_in">cursor</span>.movePosition((QTextCursor::End));</span><br><span class="line">        ui-&gt;textEdit_Recv-&gt;setTextCursor((<span class="built_in">cursor</span>));</span><br><span class="line">        socket-&gt;<span class="built_in">write</span>(<span class="string">"client hello!"</span>);</span><br><span class="line">        socket-&gt;<span class="built_in">flush</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        QString tmptime=QTime::currentTime().toString(<span class="string">"HH:mm:ss"</span>);</span><br><span class="line">        QString tmpstr = QString(<span class="string">"%1: 连接失败\n"</span>).arg(tmptime);</span><br><span class="line">        str+=tmpstr;</span><br><span class="line">        ui-&gt;textEdit_Recv-&gt;setText(str);</span><br><span class="line">        QTextCursor <span class="built_in">cursor</span>=ui-&gt;textEdit_Recv-&gt;textCursor();</span><br><span class="line">        <span class="built_in">cursor</span>.movePosition((QTextCursor::End));</span><br><span class="line">        ui-&gt;textEdit_Recv-&gt;setTextCursor((<span class="built_in">cursor</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::socket_Read_Data</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QByteArray <span class="built_in">buffer</span>;</span><br><span class="line">    <span class="comment">//读取缓冲区数据</span></span><br><span class="line">    <span class="built_in">buffer</span> = socket-&gt;readAll();</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">buffer</span>.isEmpty())</span><br><span class="line">    &#123;</span><br><span class="line">        QString str = ui-&gt;textEdit_Recv-&gt;toPlainText();</span><br><span class="line">        QString str1=<span class="built_in">buffer</span>;</span><br><span class="line">        QString tmptime=QTime::currentTime().toString(<span class="string">"HH:mm:ss"</span>);</span><br><span class="line">        QString tmpstr=QString(<span class="string">"%1 %2"</span>).arg(tmptime).arg(str1);</span><br><span class="line">        str+=tmpstr;</span><br><span class="line">        ui-&gt;textEdit_Recv-&gt;setText(str);</span><br><span class="line">        QTextCursor <span class="built_in">cursor</span>=ui-&gt;textEdit_Recv-&gt;textCursor();</span><br><span class="line">        <span class="built_in">cursor</span>.movePosition((QTextCursor::End));</span><br><span class="line">        ui-&gt;textEdit_Recv-&gt;setTextCursor((<span class="built_in">cursor</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 断开连接</span></span><br><span class="line">        socket-&gt;disconnectFromHost();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::socket_Disconnected</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    qDebug()&lt;&lt;<span class="string">"disconnected!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::sslErrors</span><span class="params">(<span class="keyword">const</span> QList&lt;QSslError&gt; &amp;errors)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foreach (<span class="keyword">const</span> QSslError &amp;error, errors)</span><br><span class="line">        qDebug() &lt;&lt; error.errorString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::socket_error</span><span class="params">(QAbstractSocket::SocketError error)</span></span>&#123;</span><br><span class="line">    qDebug()&lt;&lt;error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::on_pushButton_Clear_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ui-&gt;textEdit_Recv-&gt;setText(<span class="string">""</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端通过<code>addCaCertificates</code>信任<code>CA</code>完成握手流程</li>
<li>客户端在<code>connectToHostEncrypted</code>中设置<code>SAN</code></li>
<li>客户端发送<code>client hello!</code>后主动断开连接</li>
</ul>
<p>客户端：</p>
<div align="center"><img src="https://i.loli.net/2020/07/20/5MlsAGVFLkTNwPQ.png" width="70%"></div>

<h2 id="Demo部署"><a href="#Demo部署" class="headerlink" title="Demo部署"></a>Demo部署</h2><p>首先将服务端程序<code>tlsserver</code>打包为<code>Docker</code>镜像，上传到私有镜像仓库或在所有工作节点本地<code>docker load</code>载入。然后在集群中创建相关资源对象，包括<code>Deployment</code>、<code>Service</code>、<code>IngressRouteTCP</code>。</p>
<h3 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h3><p>👉 <em>Dockerfile</em>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> tlsserver /tlsserver</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">12345</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/tlsserver"</span>]</span></span><br></pre></td></tr></table></figure>
<p>👉 打包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t tlsserver:v0.1 .</span><br></pre></td></tr></table></figure>

<h3 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h3><p>👉 创建<code>secret</code>资源对象：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default create secret tls service1 --key=service1-key.pem --cert=service1.pem</span><br></pre></td></tr></table></figure>
<div align="center"><img src="https://i.loli.net/2020/07/20/zJjCOMk3XnpctIS.jpg" width="70%"/></div>

<ul>
<li>创建了secret</li>
</ul>
<p>👉 创建服务端相关的资源对象，包括<code>Deployment</code>、<code>Service</code>以及<code>Traefik 2</code>引入的自定义资源类型<code>IngressRouteTCP</code>，定义在文件<em>tlsserver.yaml</em>中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service1-dp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">service1-dp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">service1-dp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">service1-dp</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">service1-dp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="number">192.168</span><span class="number">.78</span><span class="number">.163</span><span class="string">:5000/tlsserver:v0.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVICE_ID</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"service1"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">12345</span></span><br><span class="line">      <span class="comment">#   volumeMounts:                   # 在tls.passthrough=true的情况下，</span></span><br><span class="line">      <span class="comment">#   - name: certs                   # 客户端与服务端进行握手操作，需</span></span><br><span class="line">      <span class="comment">#     mountPath: /certs             # 要容器中的服务能够正确加载证书</span></span><br><span class="line">      <span class="comment">#     readOnly: true                # 秘钥对。在容器中将secret挂载到</span></span><br><span class="line">      <span class="comment"># volumes:                          # 相应位置。🙄</span></span><br><span class="line">      <span class="comment"># - name: certs</span></span><br><span class="line">      <span class="comment">#   secret:</span></span><br><span class="line">      <span class="comment">#     secretName: service1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service1-dp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">service1-dp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">12345</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRouteTCP</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service1-dp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tcpep</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">HostSNI(`service1.tcpdemo.cluster`)</span>      <span class="comment"># SAN</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service1-dp</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">service1</span></span><br><span class="line">    <span class="attr">passthrough:</span> <span class="literal">false</span>                              <span class="comment"># TLS Termination</span></span><br></pre></td></tr></table></figure>
<ul>
<li>配置entryPoints为TCP入口点——tcpep</li>
<li>在路由routes中指定SAN匹配正确的服务名</li>
<li>secretName指定对应的secret</li>
<li>passthrough设置TLS终止</li>
</ul>
<h3 id="访问服务"><a href="#访问服务" class="headerlink" title="访问服务"></a>访问服务</h3><p>👉 客户端在集群外部访问服务端，基于服务名称，使用<code>TCP</code>协议完成通信：</p>
<div align="center"><img src="https://i.loli.net/2020/07/20/XL6vqJHkIF7T4YR.png" width="70%"></div>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>Traefik</code>是一款优秀的反向代理服务器，在2.0版本实现了对<code>TCP</code>协议的支持。配合<code>TLS</code>扩展协议，使<code>TCP</code>通信中也能携带类似于<code>http header</code>的额外信息，从而实现了可配置的路由功能。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://byc.github.io/2020/07/01/linux-extend-memory-using-swapfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="BYC">
      <meta itemprop="description" content="学吧，学无止境">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="卡车斯基">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/01/linux-extend-memory-using-swapfile/" class="post-title-link" itemprop="url">Linux利用swapfile扩充内存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-01 21:30:26" itemprop="dateCreated datePublished" datetime="2020-07-01T21:30:26+08:00">2020-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-02 20:50:34" itemprop="dateModified" datetime="2020-07-02T20:50:34+08:00">2020-07-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">linux使用</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在linux中进行编译时，可能会因为内存不足导致编译失败，比如<code>go build</code>不成功报<code>signal: killed</code>，或者在编译C/C++时<code>ld</code>报错<code>ld terminated with signal 9</code>。这时在不方便添加物理内存和重新分区的情况下，可以通过<code>swapfile</code>临时扩充内存。</p>
<h2 id="创建swapfile"><a href="#创建swapfile" class="headerlink" title="创建swapfile"></a>创建swapfile</h2><p>这里有两种方式可以创建<code>swapfile</code>，一种是通过<code>dd</code>命令，另一种是使用<code>fallocate</code>命令。这两个的区别在于<code>fallocate</code>只进行空间分配而不初始化，所以速度很快；另外有些情况下不支持<code>fallocate</code>操作，而只能选择dd。</p>
<blockquote>
<p>FALLOCATE(1)<br>fallocate  is  used to manipulate the allocated disk space for a file, either to deallocate or preallocate it.  For filesystems which support the fallocate system call,preallocation is done quickly by allocating blocks and marking them as uninitialized, requiring no IO to the data blocks.  This is much faster than creating a  file  by filling it with zeroes.</p>
</blockquote>
<h3 id="使用dd创建swapfile"><a href="#使用dd创建swapfile" class="headerlink" title="使用dd创建swapfile"></a>使用dd创建swapfile</h3><p><code>dd</code>命令是Unix和类Unix系统中的一个实用工具，用于将字节从输入经过一定的转换复制到输出中，输入输出都可以是任意的文件或设备。生成一个8GB的<code>swapfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;swapfile.8G bs&#x3D;1MiB count&#x3D;8192</span><br></pre></td></tr></table></figure>
<p>dd参数意义</p>
<ul>
<li>if 输入，使用/dev/zero将swapfile内部填充’0’</li>
<li>of 输出</li>
<li>bs 按块拷贝，每块的大小</li>
<li>count 拷贝的块数</li>
</ul>
<h3 id="使用fallocate创建swapfile"><a href="#使用fallocate创建swapfile" class="headerlink" title="使用fallocate创建swapfile"></a>使用fallocate创建swapfile</h3><p>使用<code>fallocate</code>命令快速生成<code>swapfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fallocate -l 8G swapfile.8GB</span><br></pre></td></tr></table></figure>
<p>fallocate参数意义</p>
<ul>
<li>-l 生成文件的长度，可以使用K、M、G等单位</li>
</ul>
<h2 id="修改swapfile权限"><a href="#修改swapfile权限" class="headerlink" title="修改swapfile权限"></a>修改swapfile权限</h2><p><code>swapfile</code>用于交换内存数据，所以安全起见更正文件权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 0600 swapfile.8GB</span><br></pre></td></tr></table></figure>

<h2 id="设置交换分区"><a href="#设置交换分区" class="headerlink" title="设置交换分区"></a>设置交换分区</h2><p>将文件设置为交换分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkswap swapfile.8GB</span><br></pre></td></tr></table></figure>

<h2 id="挂载交换分区"><a href="#挂载交换分区" class="headerlink" title="挂载交换分区"></a>挂载交换分区</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon swapfile.8GB</span><br></pre></td></tr></table></figure>
<p>可以通过<code>free</code>命令查看交换分区是否正常使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h</span><br></pre></td></tr></table></figure>
<p>8G的交换分区已挂载👇<br><img src="https://i.loli.net/2020/07/02/FOHizSKNsnQ9XLD.png" alt="WechatIMG136.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文介绍了如何使用<code>swapfile</code>增加交换分区，从而解决内存不足导致的各种问题。在支持的情况下，首选使用<code>fallocate</code>快速创建<code>swapfile</code>文件。另外，<code>swapon</code>挂载交换分区在重启后需要再次手动挂载，可以在<code>/etc/fstab</code>文件中添加挂载项，实现开机自动挂载。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="BYC"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">BYC</p>
  <div class="site-description" itemprop="description">学吧，学无止境</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/BYC" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;BYC" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1457409696@qq.com" title="E-Mail → mailto:1457409696@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BYC</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">14k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13 分钟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
